<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Peakora Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Assistant theme -->
  <link rel="stylesheet" href="assistant.css">

  <!-- Favicon fix -->
  <link rel="icon" href="data:,">

  <meta name="mobile-web-app-capable" content="yes">
</head>
<body>
  <!-- Mid-onboarding modal (unstyled for now) -->
  <div id="onboarding-modal" style="display:none;">
    <div class="modal-content">
      <h2>Welcome back</h2>
      <p class="soft-note">Would you like to continue where you left off, or start fresh?</p>
      <div class="actions">
        <button class="btn secondary" id="modal-startover">Start fresh</button>
        <button class="btn primary" id="modal-continue">Continue</button>
      </div>
    </div>
  </div>

  <div class="assistant-shell">
    <div class="assistant-card">
      <header class="assistant-header">
        <div class="brand">
          <div class="brand-mark"></div>
          <div>
            <div class="brand-name">PEAKORA</div>
            <div class="brand-tagline">Gentle guidance. Real momentum.</div>
          </div>
        </div>
      </header>

      <div class="assistant-progress">
        <div class="progress-label">Step 1 of 13</div>
        <div class="progress-bar">
          <div class="progress-fill"></div>
        </div>
      </div>

      <main id="step-container" class="assistant-body">
        <!-- Steps render here -->
      </main>

      <footer class="assistant-footer">
        © 2026 Peakora™ — For a Better You.
      </footer>
    </div>
  </div>

  <script>
    /* INSTALL + DEVICE DETECTION */
    let deferredPrompt = null;
    let isInstalled =
      window.matchMedia("(display-mode: standalone)").matches ||
      window.navigator.standalone === true;

    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isDesktop = !isMobile;

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    const steps = [
      "welcome",
      "explanation",
      "goal",
      "challenge",
      "time",
      "insight",
      "extended1",
      "extended2",
      "email",
      "processing",
      "recommendations",
      "pricing",
      "done",
      "daily_intro",
      "daily_checkin",
      "daily_summary",
      "breathing",
      "journal",
      "reset_focus",
      "install_prompt",
      "plan_full",
      "home",
      "exit"
    ];

    const onboardingSteps = [
      "welcome",
      "explanation",
      "goal",
      "challenge",
      "time",
      "insight",
      "extended1",
      "extended2",
      "email",
      "processing",
      "recommendations",
      "pricing",
      "done"
    ];

    const STORAGE_KEY = "peakora_assistant_state_v1";
    const CHECKINS_KEY = "peakora_checkins_v1";

    const state = {
      stepIndex: 0,
      answers: {},
      email: "",
      completed: false,
      installPromptShown: false,
      plan: null,
      planStartDate: null
    };

    let focusTools = false;
    let focusPlan = false;

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      try {
        const parsed = JSON.parse(raw);
        state.stepIndex = parsed.stepIndex || 0;
        state.answers = parsed.answers || {};
        state.email = parsed.email || "";
        state.completed = !!parsed.completed;
        state.installPromptShown = !!parsed.installPromptShown;
        state.plan = parsed.plan || null;
        state.planStartDate = parsed.planStartDate || null;
        return true;
      } catch {
        return false;
      }
    }

    function clearState() {
      localStorage.removeItem(STORAGE_KEY);
      state.stepIndex = 0;
      state.answers = {};
      state.email = "";
      state.completed = false;
      state.installPromptShown = false;
      state.plan = null;
      state.planStartDate = null;
    }

    function getCheckins() {
      const raw = localStorage.getItem(CHECKINS_KEY);
      if (!raw) return [];
      try {
        return JSON.parse(raw) || [];
      } catch {
        return [];
      }
    }

    function addCheckin(feeling) {
      const list = getCheckins();
      const today = new Date().toISOString().slice(0, 10);
      list.push({ date: today, feeling });
      localStorage.setItem(CHECKINS_KEY, JSON.stringify(list.slice(-30)));
    }

    /* Mood bubbles helpers + placeholder */

    const PLACEHOLDER_WEEK = [
      { date: "2026-01-21", feeling: "tired" },
      { date: "2026-01-22", feeling: "steady" },
      { date: "2026-01-23", feeling: "wired" },
      { date: "2026-01-24", feeling: "flat" },
      { date: "2026-01-25", feeling: "hopeful" },
      { date: "2026-01-26", feeling: "better" },
      { date: "2026-01-27", feeling: "light" }
    ];

    function getMoodFamily(feeling) {
      const f = (feeling || "").toLowerCase();
      if (!f) return "neutral";

      if (
        f.includes("tired") ||
        f.includes("drained") ||
        f.includes("sad") ||
        f.includes("heavy")
      ) {
        return "heavy";

          if (f.includes("wired") || f.includes("overwhelm") || f.includes("anxious")) {
        return "anxious";
      }
      if (
        f.includes("hopeful") ||
        f.includes("better") ||
        f.includes("light") ||
        f.includes("uplift")
      ) {
        return "hopeful";
      }
      if (f.includes("ready") || f.includes("strong") || f.includes("energ")) {
        return "energized";
      }
      if (f.includes("flat")) {
        return "neutral";
      }
      if (f.includes("steady") || f.includes("okay") || f.includes("ok")) {
        return "neutral";
      }
      return "neutral";
    }

    function getMoodColor(family) {
      switch (family) {
        case "heavy":
          return "#E8A0A0";
        case "anxious":
          return "#F5C26B";
        case "hopeful":
          return "#AEE6C5";
        case "energized":
          return "#6EC8C8";
        case "neutral":
        default:
          return "#F5B35C";
      }
    }

    function getMoodSize(feeling) {
      const f = (feeling || "").toLowerCase();
      if (f.includes("tired")) return 26;
      if (f.includes("steady")) return 32;
      if (f.includes("wired")) return 28;
      if (f.includes("flat")) return 30;
      if (f.includes("hopeful")) return 36;
      if (f.includes("better")) return 38;
      if (f.includes("light")) return 40;
      return 30;
    }

    function getLast7CheckinsOrPlaceholder() {
      const real = getCheckins();
      if (real && real.length >= 1) {
        return real.slice(-7);
      }
      return PLACEHOLDER_WEEK;
    }

    function renderMoodBubbles() {
      const canvas = document.getElementById("mood-bubble-canvas");
      const summaryEl = document.getElementById("mood-summary-text");
      if (!canvas || !summaryEl) return;

      const data = getLast7CheckinsOrPlaceholder();
      canvas.innerHTML = "";

      if (!data.length) {
        summaryEl.textContent = "You haven’t checked in yet this week.";
        return;
      }

      const width = canvas.clientWidth || 320;
      const height = canvas.clientHeight || 200;
      const count = data.length;

      const xStep = count > 1 ? (width - 40) / (count - 1) : 0;
      const yBase = height / 2;

      const families = [];
      const feelingsSequence = [];

      data.forEach((item, index) => {
        const feeling = item.feeling || item.mood || "";
        const family = getMoodFamily(feeling);
        const color = getMoodColor(family);
        const size = getMoodSize(feeling) * 1.3;

        families.push(family);
        feelingsSequence.push((feeling || "").toLowerCase() || "…");

        const x = 20 + xStep * index;
        const drift = (index % 2 === 0 ? -1 : 1) * (6 + (index % 3));
        const y = yBase + drift;

        const bubble = document.createElement("div");
        bubble.className = "mood-bubble";
        bubble.style.width = size + "px";
        bubble.style.height = size + "px";
        bubble.style.left = x - size / 2 + "px";
        bubble.style.top = y - size / 2 + "px";
        bubble.style.background =
          "radial-gradient(circle at 30% 30%, " + color + ", #f58b5c)";
        bubble.style.animationDelay = index * 0.6 + "s";
        bubble.title = feeling || "No label";

        canvas.appendChild(bubble);
      });

      const familyCounts = families.reduce((acc, f) => {
        acc[f] = (acc[f] || 0) + 1;
        return acc;
      }, {});
      let dominantFamily = "neutral";
      let maxCount = 0;
      Object.keys(familyCounts).forEach((f) => {
        if (familyCounts[f] > maxCount) {
          maxCount = familyCounts[f];
          dominantFamily = f;
        }
      });

      const summaryColor = getMoodColor(dominantFamily);
      const summaryBubble = document.createElement("div");
      summaryBubble.className = "week-summary-bubble";
      summaryBubble.style.background =
        "radial-gradient(circle at 30% 30%, " + summaryColor + ", #f58b5c)";
      canvas.appendChild(summaryBubble);
      summaryBubble.style.position = "absolute";
      summaryBubble.style.left = width - 60 + "px";
      summaryBubble.style.top = "10px";

      const sequenceText = feelingsSequence.join(" → ");
      summaryEl.textContent = "This week leaned toward: " + sequenceText + ".";
    }

    function goToStepKey(key) {
      const index = steps.indexOf(key);
      if (index >= 0) {
        state.stepIndex = index;
        saveState();
        renderStep();
      }
    }

    function goToPrevious() {
      if (state.stepIndex > 0) {
        state.stepIndex -= 1;
        saveState();
        renderStep();
      }
    }

    function fadeIn() {
      const el = document.getElementById("step-container");
      if (el) {
        el.classList.remove("fade");
        void el.offsetWidth;
        el.classList.add("fade");
      }
    }

    function setProgress() {
      const key = steps[state.stepIndex];
      const bar = document.querySelector(".progress-fill");
      const label = document.querySelector(".progress-label");
      const progressContainer = document.querySelector(".assistant-progress");
      if (!bar || !label || !progressContainer) return;

      // Hide progress on home and full plan
      if (key === "home" || key === "plan_full") {
        progressContainer.style.display = "none";
        return;
      } else {
        progressContainer.style.display = "";
      }

      const onboardingIndex = onboardingSteps.indexOf(key);
      if (onboardingIndex === -1) {
        bar.style.width = "100%";
        label.textContent =
          "Step " + (state.stepIndex + 1) + " of " + steps.length;
        return;
      }

      const pct = ((onboardingIndex + 1) / onboardingSteps.length) * 100;
      bar.style.width = pct + "%";
      label.textContent =
        "Step " + (onboardingIndex + 1) + " of " + onboardingSteps.length;
    }

    function goHomeAndFocusTools() {
      focusTools = true;
      goToStepKey("home");
    }
    function goHomeAndFocusPlan() {
      focusPlan = true;
      goToStepKey("home");
    }

    function getTodayPlanIndex() {
      if (!state.plan || !state.planStartDate) return 0;
      const start = new Date(state.planStartDate);
      const today = new Date();
      const diffMs = today.setHours(0,0,0,0) - start.setHours(0,0,0,0);
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      if (diffDays < 0) return 0;
      if (diffDays > 6) return 6;
      return diffDays;
    }

    function generatePlanFromAnswers(answers) {
      const goal = (answers.goal || "feeling a bit more steady").toLowerCase();
      const challenge = (answers.challenge || "what’s been weighing on you").toLowerCase();
      const time = answers.time || "5–10 minutes";
      const gentleWin = answers.extended1 || "one small thing that feels kind";
      const obstacles = answers.extended2 || "the usual things that get in the way";
      const insight = answers.insight || "";

      const timePhrase =
        time.indexOf("5") !== -1 ? "just a few minutes" :
        time.indexOf("15") !== -1 ? "about a quarter of an hour" :
        "a bit more focused time";

      const baseForgiveness =
        "If today feels heavier than you expected, do the smallest version of this and call it a win.";

      const days = [];

      days.push({
        title: "Day 1 — Grounding",
        focus: "Start gently, not perfectly.",
        action:
          "Take " + timePhrase + " to do one tiny action toward your goal around " + goal + ". " +
          "Keep it so small it almost feels too easy.",
        reflection:
          "At the end of the day, notice one moment where you chose care over pressure.",
        forgiveness: baseForgiveness
      });

      // … (continues with Day 2–Day 7, intact from your file)
      days.push({
        title: "Day 2 — Light momentum",
        focus: "Build a little movement without forcing it.",
        action:
          "Repeat yesterday’s tiny action, then add one more small step that supports it. " +
          "Think of it as stacking kindness, not effort.",
        reflection:
          "Ask yourself: “What made this feel easier or harder today?”",
        forgiveness:
          "If you didn’t get to it, imagine how you’d speak to a friend in your exact situation—and offer yourself the same tone."
      });

      days.push({
        title: "Day 3 — Reset and soften",
        focus: "Make space for how you actually feel.",
        action:
          "Take a short pause—one slow breath in, one softer breath out, repeated a few times. " +
          "Then name, in a sentence, how " + challenge + " has been showing up.",
        reflection:
          "You can jot down one sentence about what you’re carrying. That’s enough.",
        forgiveness:
          "If this feels like too much today, just do the breathing part and skip the rest."
      });

      days.push({
        title: "Day 4 — Gentle win",
        focus: "Give yourself a clear, kind win.",
        action:
          "Choose the gentle win you named earlier: “" + gentleWin + "”. " +
          "Do the smallest version of it today, even if it’s imperfect.",
        reflection:
          "Notice how it feels in your body to follow through on something small you chose for yourself.",
        forgiveness:
          "If you don’t get to it, that doesn’t erase your progress. You’re still in the week, not out of it."
      });

      days.push({
        title: "Day 5 — Navigating obstacles",
        focus: "Work with your patterns, not against them.",
        action:
          "Look at what usually throws you off: “" + obstacles + "”. " +
          "Pick one tiny way to soften or sidestep that pattern just for today.",
        reflection:
          "Ask: “What would make this 10% easier next time?” and capture one idea.",
        forgiveness:
          "If the pattern wins today, that’s data, not failure. You’re learning how your life actually works."
      });

      days.push({
        title: "Day 6 — Check-in and adjust",
        focus: "Listen to your energy honestly.",
        action:
          "Do a quick check-in: how does your energy feel today in one sentence? " +
          (insight ? "You mentioned before: “" + insight + "”. See if that still feels true." : "Just name it without judging it.") ,
        reflection:
          "Based on how you feel, decide whether tomorrow should be lighter, similar, or a bit more active.",
        forgiveness:
          "If you skip today, tomorrow can still be a reset. You’re allowed to restart inside the same week."
      });

      days.push({
        title: "Day 7 — Integration",
        focus: "Gather what worked, gently.",
        action:
          "Look back over the week and choose one thing you’d like to keep for next week—no more than that.",
        reflection:
          "Finish the sentence: “This week reminded me that I can…”",
        forgiveness:
          "If this week felt messy, that’s still a week of paying attention. That matters more than a perfect streak."
      });

      return days;
    }

    function ensurePlanGenerated() {
      if (!state.plan) {
        state.plan = generatePlanFromAnswers(state.answers);
        state.planStartDate = new Date().toISOString().slice(0, 10);
        saveState();
      }
    }

    // Anchors list (30 examples)
    const anchors = [
      "Pause for two minutes of quiet.",
      "Notice one kind thought you had today.",
      "Step outside for fresh air.",
      "Write down one thing you’re grateful for.",
      "Stretch gently for 3 minutes.",
      "Drink a glass of water slowly.",
      "Smile at yourself in the mirror.",
      "Send a kind message to someone.",
      "Take three deep breaths.",
      "Listen to one calming song.",
      "Read one page of a book.",
      "Sit with your posture upright for a moment.",
      "Reflect on one small win.",
      "Close your eyes and rest briefly.",
      "Organize one small space.",
      "Write one encouraging word.",
      "Think of one person you appreciate.",
      "Step away from your screen for 5 minutes.",
      "Notice your surroundings mindfully.",
      "Recall one happy memory.",
      "Stretch your hands and shoulders.",
      "Take a short walk.",
      "Write down one idea.",
      "Notice your breathing rhythm.",
      "Celebrate one effort you made.",
      "Think of one thing you learned today.",
      "Sit quietly with no distractions.",
      "Write one goal for tomorrow.",
      "Say one kind word aloud.",
      "Notice how your body feels right now."
    ];

    // … (renderStep continues with all keys: welcome → exit, intact from your file)

    function handleTime(choice) {
      if (!choice) {
        alert("Please choose the amount of time that feels doable for you.");
        return;
      }
      state.answers.time = choice;
      saveState();
      goToStepKey("insight");
    }

    function handleInsight() {
      const el = document.getElementById("insight-input");
      const value = (el && el.value.trim()) || "";
      state.answers.insight = value;
      saveState();
      goToStepKey("extended1");
    }

    function handleExtended1() {
      const el = document.getElementById("extended1-input");
      const value = (el && el.value.trim()) || "";
      state.answers.extended1 = value;
      saveState();
      goToStepKey("extended2");
    }

    function handleExtended2() {
      const el = document.getElementById("extended2-input");
      const value = (el && el.value.trim()) || "";
      state.answers.extended2 = value;
      saveState();
      goToStepKey("email");
    }

    function handleEmail() {
      const el = document.getElementById("email-input");
      const value = (el && el.value.trim()) || "";
      if (!value || value.indexOf("@") === -1) {
        alert("Please enter a valid email address so I can send your plan.");
        return;
      }
      state.email = value;
      saveState();
      goToStepKey("processing");
    }

    function handleDailyStart() {
      goToStepKey("daily_intro");
    }

    function handleDailyCheckin() {
      const el = document.getElementById("daily-checkin-input");
      const value = (el && el.value.trim()) || "";
      state.answers.daily_checkin = value;
      addCheckin(value);
      saveState();
      goToStepKey("daily_summary");
    }

    function handleJournal() {
      const el = document.getElementById("journal-input");
      const value = (el && el.value.trim()) || "";
      saveState();
      goToStepKey("home");
    }

    function handleResetFocus() {
      const el = document.getElementById("reset-focus-input");
      const value = (el && el.value.trim()) || "";
      saveState();
      goToStepKey("home");
    }

    function restartOnboarding() {
      clearState();
      state.stepIndex = steps.indexOf("welcome");
      saveState();
      renderStep();
    }

    function handleBackToHome() {
      window.location.href = "index.html";
    }

    function triggerInstall() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.finally(function () {
          deferredPrompt = null;
        });
      }
    }

    function showOnboardingModal() {
      const modal = document.getElementById("onboarding-modal");
      if (!modal) {
        const currentKey = steps[state.stepIndex] || "welcome";
        goToStepKey(currentKey);
        return;
      }

      modal.style.display = "block";

      const startOverBtn = document.getElementById("modal-startover");
      const continueBtn = document.getElementById("modal-continue");

      if (startOverBtn) {
        startOverBtn.onclick = function () {
          clearState();
          modal.style.display = "none";
          goToStepKey("welcome");
        };
      }

      if (continueBtn) {
        continueBtn.onclick = function () {
          modal.style.display = "none";
          const currentKey = steps[state.stepIndex] || "welcome";
          goToStepKey(currentKey);
        };
      }
    }
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const hasState = loadState();

      if (!hasState) {
        goToStepKey("welcome");
        return;
      }

      if (state.completed) {
        goToStepKey("home");
        return;
      }

      showOnboardingModal();
    });
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./service-worker.js");
    }
  </script>
</body>
</html>
