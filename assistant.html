<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Peakora Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- iOS PWA support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Peakora">
  <link rel="apple-touch-icon" href="./assets/peakora-icon-192.png">

  <!-- Neutral premium Peakora dot favicon -->
  <link rel="icon" href="data:image/svg+xml,
    <svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'>
      <circle cx='32' cy='32' r='28' fill='%23f5b35c'/>
    </svg>">

  <!-- Correct manifest path -->
  <link rel="manifest" href="./manifest.json">

  <!-- Styles -->
  <link rel="stylesheet" href="./assistant.css" />
</head>

<body>
  <div class="assistant-shell">
    <div class="assistant-card fade">
      <header class="assistant-header">
        <div class="brand">
          <span class="brand-mark"></span>
          <span class="brand-name">PEAKORA</span>
        </div>
        <div class="brand-tagline">Gentle guidance. Real momentum.</div>
      </header>

      <div class="assistant-progress">
        <div class="progress-label" id="progress-label">Step 1 of 13</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>

      <main id="step-container" class="assistant-body fade">
      </main>

      <footer class="assistant-footer">
        <span>Peakora Assistant · This is not medical advice.</span>
      </footer>
    </div>
  </div>

  <script>
    /* INSTALL EVENT CAPTURE */
    let deferredPrompt = null;
    let isInstalled = window.matchMedia('(display-mode: standalone)').matches;

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    const steps = [
      "welcome",
      "explanation",
      "goal",
      "challenge",
      "time",
      "insight",
      "extended1",
      "extended2",
      "email",
      "processing",
      "recommendations",
      "pricing",
      "done",
      "returning",
      "daily_intro",
      "daily_checkin",
      "daily_summary",
      "install_prompt",
      "exit"
    ];

    const onboardingSteps = [
      "welcome",
      "explanation",
      "goal",
      "challenge",
      "time",
      "insight",
      "extended1",
      "extended2",
      "email",
      "processing",
      "recommendations",
      "pricing",
      "done"
    ];

    const state = {
      stepIndex: 0,
      answers: {},
      email: "",
      completed: false,
    };

    const STORAGE_KEY = "peakora_assistant_state_v1";

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      try {
        const parsed = JSON.parse(raw);
        state.stepIndex = parsed.stepIndex || 0;
        state.answers = parsed.answers || {};
        state.email = parsed.email || "";
        state.completed = !!parsed.completed;
        return true;
      } catch {
        return false;
      }
    }

    function clearState() {
      localStorage.removeItem(STORAGE_KEY);
      state.stepIndex = 0;
      state.answers = {};
      state.email = "";
      state.completed = false;
    }

    function setProgress() {
      const label = document.getElementById("progress-label");
      const fill = document.getElementById("progress-fill");
      const key = steps[state.stepIndex];
      const idx = onboardingSteps.indexOf(key);

      if (idx === -1) {
        label.textContent = "Peakora Assistant";
        fill.style.width = "0%";
        return;
      }

      const stepNum = idx + 1;
      const total = onboardingSteps.length;
      label.textContent = `Step ${stepNum} of ${total}`;
      fill.style.width = `${(stepNum / total) * 100}%`;
    }

    function goToStepKey(key) {
      const idx = steps.indexOf(key);
      if (idx === -1) return;
      state.stepIndex = idx;
      saveState();
      renderStep();
    }

    function goToNext() {
      state.stepIndex += 1;
      saveState();
      renderStep();
    }

    function goToPrevious() {
      if (state.stepIndex === 0) return;
      state.stepIndex -= 1;
      saveState();
      renderStep();
    }

    function fadeIn() {
      const card = document.querySelector(".assistant-card");
      const body = document.querySelector(".assistant-body");
      card.classList.remove("fade");
      body.classList.remove("fade");
      void card.offsetWidth;
      card.classList.add("fade");
      body.classList.add("fade");
    }

    function renderStep() {
      fadeIn();
      const container = document.getElementById("step-container");
      const key = steps[state.stepIndex];
      setProgress();

      if (key === "welcome") {
        container.innerHTML = `
          <div class="step">
            <h1>Hi, I’m Peakora.</h1>
            <p>Let’s take a gentle step toward the version of you that feels more grounded and steady.</p>
            <div class="actions">
              <button class="btn secondary" onclick="handleBackToHome()">Back</button>
              <button class="btn primary" onclick="goToStepKey('explanation')">Begin</button>
            </div>
          </div>`;
        return;
      }

      if (key === "explanation") {
        container.innerHTML = `
          <div class="step">
            <h2>How this works</h2>
            <p>I’ll ask a few simple questions about your energy, your time, and what’s been weighing on you.</p>
            <p>Then I’ll shape a 7‑day plan that feels doable, not overwhelming.</p>
            <div class="actions">
              <button class="btn secondary" onclick="goToPrevious()">Back</button>
              <button class="btn primary" onclick="goToStepKey('goal')">Continue</button>
            </div>
          </div>`;
        return;
      }

      if (key === "goal") {
        container.innerHTML = `
          <div class="step">
            <h2>What’s one area you’d like to feel better in?</h2>
            <textarea class="input" id="goal-input" placeholder="Sleep, stress, focus, movement… whatever feels true."></textarea>
            <div class="actions">
              <button class="btn secondary" onclick="goToPrevious()">Back</button>
              <button class="btn primary" onclick="handleGoal()">Continue</button>
            </div>
          </div>`;
        return;
      }

      if (key === "challenge") {
        container.innerHTML = `
          <div class="step">
            <h2>What’s been making this hard lately?</h2>
            <textarea class="input" id="challenge-input" placeholder="Be honest. Overwhelm, time, burnout, pain…"></textarea>
            <div class="actions">
              <button class="btn secondary" onclick="goToPrevious()">Back</button>
              <button class="btn primary" onclick="handleChallenge()">Continue</button>
            </div>
          </div>`;
        return;
      }

      if (key === "time") {
        container.innerHTML = `
          <div class="step">
            <h2>How much time feels doable for you right now?</h2>
            <div class="options">
              <button class="btn ghost" onclick="handleTime('5–10 minutes')">5–10 minutes</button>
              <button class="btn ghost" onclick="handleTime('15–20 minutes')">15–20 minutes</button>
              <button class="btn ghost" onclick="handleTime('30+ minutes')">30+ minutes</button>
            </div>
            <div class="actions">
              <button class="btn secondary" onclick="goToPrevious()">Back</button>
            </div>
          </div>`;
        return;
      }

      if (key === "insight") {
        container.innerHTML = `
          <div class="step">
            <h2>Is there anything else I should know about your energy or mood lately?</h2>
            <textarea class="input" id="insight-input" placeholder="You can skip this if nothing comes to mind."></textarea>
            <div class="actions">
              <button class="btn secondary" onclick="goToPrevious()">Back</button>
              <button class="btn primary" onclick="handleInsight()">Continue</button>
            </div>
          </div>`;
        return;
      }

      if (key === "extended1") {
        container.innerHTML = `
          <div class="step">
            <h2>What would feel like a gentle win this week?</h2>
            <textarea class="input" id="extended1-input" placeholder="Something small, kind, and realistic."></textarea>
            <div class="actions">
              <button class="btn secondary" onclick="goToPrevious()">Back</button>
              <button class="btn primary" onclick="handleExtended1()">Continue</button>
            </div>
          </div>`;
        return;
      }

      if (key === "extended2") {
        container.innerHTML = `
          <div class="step">
            <h2>What tends to throw you off when you try to make changes?</h2>
            <textarea class="input" id="extended2-input" placeholder="Patterns, triggers, thoughts…"></textarea>
            <div class="actions">
              <button class="btn secondary" onclick="goToPrevious()">Back</button>
              <button class="btn primary" onclick="handleExtended2()">Continue</button>
            </div>
          </div>`;
        return;
      }

      if (key === "email") {
        container.innerHTML = `
          <div class="step">
            <h2>Where should I send your plan?</h2>
            <input type="email" class="input" id="email-input" placeholder="you@example.com" value="${state.email}">
            <div class="actions">
              <button class="btn secondary" onclick="goToPrevious()">Back</button>
              <button class="btn primary" onclick="handleEmail()">Send my plan</button>
            </div>
          </div>`;
        return;
      }

      if (key === "processing") {
        container.innerHTML = `
          <div class="step step-centered">
            <h2>One moment</h2>
            <p>I’m shaping your plan with everything you shared.</p>
            <div class="loader"></div>
          </div>`;
        setTimeout(() => goToStepKey("recommendations"), 2400);
        return;
      }

      if (key === "recommendations") {
        container.innerHTML = `
          <div class="step">
            <h2>Your plan is ready</h2>
            <p>I’ve sent it to <strong>${state.email}</strong>.</p>
            <p>Here’s a small preview of what you’ll find inside:</p>
            <ul class="preview-list">
              <li>Daily focus that matches your energy</li>
              <li>One anchor habit to keep you steady</li>
              <li>Built‑in forgiveness for off days</li>
            </ul>
            <div class="actions">
              <button class="btn primary" onclick="goToStepKey('pricing')">Continue</button>
            </div>
          </div>`;
        return;
      }

      if (key === "pricing") {
        container.innerHTML = `
          <div class="step">
            <h2>What’s coming next</h2>
            <p>Right now, Peakora is free. Soon, you’ll be able to:</p>
            <ul class="preview-list">
              <li>Save multiple plans</li>
              <li>Track gentle daily check‑ins</li>
              <li>See patterns and insights over time</li>
            </ul>
            <p>You’ll also be able to add Peakora to your home screen for quick access.</p>
            <div class="actions">
              <button class="btn primary" onclick="goToStepKey('done')">Finish</button>
            </div>
          </div>`;
        return;
      }

      if (key === "done") {
        state.completed = true;
        saveState();
        container.innerHTML = `
          <div class="step step-centered">
            <h2>Your plan is on its way</h2>
            <p>You showed up for yourself today. That matters more than you think.</p>
            <p class="soft-note">Come back anytime for a new plan or a gentle check‑in.</p>
          </div>`;
        setTimeout(() => {
          if (!isInstalled && deferredPrompt) {
            goToStepKey("install_prompt");
          }
        }, 800);
        return;
      }

      if (key === "returning") {
        container.innerHTML = `
          <div class="step">
            <h2>Welcome back</h2>
            <p>Do you want to start a fresh plan or check in with how you’re feeling today?</p>
            <div class="options vertical">
              <button class="btn ghost" onclick="handleDailyStart()">Daily check‑in</button>
              <button class="btn ghost" onclick="restartOnboarding()">Start a new 7‑day plan</button>
            </div>
          </div>`;
        if (!isInstalled && deferredPrompt) {
          container.innerHTML += `
            <div class="actions" style="margin-top: 20px; justify-content: center;">
              <button class="btn primary" onclick="goToStepKey('install_prompt')">Install Peakora</button>
            </div>`;
        }
        return;
      }

      if (key === "daily_intro") {
        container.innerHTML = `
          <div class="step">
            <h2>Let’s do a quick check‑in</h2>
            <p>Just a few gentle questions to see where you’re at today.</p>
            <div class="actions">
              <button class="btn secondary" onclick="goToStepKey('returning')">Back</button>
              <button class="btn primary" onclick="goToStepKey('daily_checkin')">Begin</button>
            </div>
          </div>`;
        return;
      }

      if (key === "daily_checkin") {
        container.innerHTML = `
          <div class="step">
            <h2>How are you feeling right now?</h2>
            <textarea class="input" id="daily-checkin-input" placeholder="Tired, okay, wired, flat, hopeful… whatever is true."></textarea>
            <div class="actions">
              <button class="btn secondary" onclick="goToStepKey('daily_intro')">Back</button>
              <button class="btn primary" onclick="handleDailyCheckin()">Continue</button>
            </div>
          </div>`;
        return;
      }

      if (key === "daily_summary") {
        const feeling = state.answers.daily_checkin || "how you’re feeling today";
        container.innerHTML = `
          <div class="step step-centered">
            <h2>Thank you for checking in</h2>
            <p>I’ve noted ${feeling.toLowerCase()} as part of your ongoing pattern.</p>
            <p class="soft-note">Small moments of honesty like this are what slowly shift things.</p>
            <div class="actions">
              <button class="btn primary" onclick="goToStepKey('install_prompt')">Continue</button>
            </div>
          </div>`;
        return;
      }

      if (key === "install_prompt") {
        container.innerHTML = `
          <div class="step step-centered">
            <h2>Make Peakora your space</h2>
            <p class="soft-note">A calmer, faster, more grounded experience — right from your home screen.</p>

            <ul class="preview-list" style="margin-top: 14px; text-align: left;">
              <li>One‑tap access to your daily check‑ins</li>
              <li>Your 7‑day plans available even offline</li>
              <li>A quiet space without browser tabs or noise</li>
              <li>Faster loading and smoother transitions</li>
              <li>New tools coming soon: mood tracker, micro‑journal, breath reset</li>
            </ul>

            <div class="actions" style="margin-top: 20px; justify-content: center;">
              <button class="btn primary" onclick="triggerInstall()">Install Peakora</button>
            </div>

            <div class="actions" style="margin-top: 8px; justify-content: center;">
              <button class="btn ghost" onclick="goToStepKey('exit')">Maybe later</button>
            </div>
          </div>`;
        return;
      }

      if (key === "exit") {
        container.innerHTML = `
          <div class="step step-centered">
            <h2>We’re done for now</h2>
            <p>You can close this tab whenever you’re ready.</p>
            <p class="soft-note">When you’re back, I’ll be right where you left me.</p>
          </div>`;
        return;
      }
    }

    function handleGoal() {
      const el = document.getElementById("goal-input");
      const value = (el.value || "").trim();
      if (!value) {
        el.classList.add("input-error");
        return;
      }
      el.classList.remove("input-error");
      state.answers.goal = value;
      saveState();
      goToStepKey("challenge");
    }

    function handleChallenge() {
      const el = document.getElementById("challenge-input");
      const value = (el.value || "").trim();
      if (!value) {
        el.classList.add("input-error");
        return;
      }
      el.classList.remove("input-error");
      state.answers.challenge = value;
      saveState();
      goToStepKey("time");
    }

    function handleTime(choice) {
      state.answers.time = choice;
      saveState();
      goToStepKey("insight");
    }

    function handleInsight() {
      const el = document.getElementById("insight-input");
      const value = (el.value || "").trim();
      if (value) {
        state.answers.insight = value;
        saveState();
      }
      goToStepKey("extended1");
    }

    function handleExtended1() {
      const el = document.getElementById("extended1-input");
      const value = (el.value || "").trim();
      if (!value) {
        el.classList.add("input-error");
        return;
      }
      el.classList.remove("input-error");
      state.answers.extended1 = value;
      saveState();
      goToStepKey("extended2");
    }

    function handleExtended2() {
      const el = document.getElementById("extended2-input");
      const value = (el.value || "").trim();
      if (!value) {
        el.classList.add("input-error");
        return;
      }
      el.classList.remove("input-error");
      state.answers.extended2 = value;
      saveState();
      goToStepKey("email");
    }

    function handleEmail() {
      const el = document.getElementById("email-input");
      const value = (el.value || "").trim();
      if (!value || !value.includes("@")) {
        el.classList.add("input-error");
        return;
      }
      el.classList.remove("input-error");
      state.email = value;
      saveState();
      goToStepKey("processing");
    }

    function handleDailyStart() {
      goToStepKey("daily_intro");
    }

    function handleDailyCheckin() {
      const el = document.getElementById("daily-checkin-input");
      const value = (el.value || "").trim();
      if (!value) {
        el.classList.add("input-error");
        return;
      }
      el.classList.remove("input-error");
      state.answers.daily_checkin = value;
      saveState();
      goToStepKey("daily_summary");
    }

    function restartOnboarding() {
      clearState();
      goToStepKey("welcome");
    }

    function handleBackToHome() {
      const ref = document.referrer || "";
      if (ref.includes("index.html")) {
        window.location.href = "index.html";
      } else {
        goToStepKey("returning");
      }
    }

    function triggerInstall() {
      if (!deferredPrompt) {
        goToStepKey("exit");
        return;
      }

      deferredPrompt.prompt();

      deferredPrompt.userChoice.then((choice) => {
        deferredPrompt = null;

        if (choice.outcome === "accepted") {
          isInstalled = true;
          goToStepKey("exit");
        } else {
          goToStepKey("exit");
        }
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const hasState = loadState();
      if (!hasState) {
        goToStepKey("welcome");
        return;
      }
      if (state.completed) {
        goToStepKey("returning");
        return;
      }
      goToStepKey(steps[state.stepIndex] || "welcome");
    });
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./service-worker.js");
    }
  </script>

</body>
</html>
