<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Peakora Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Assistant theme -->
  <link rel="stylesheet" href="assistant.css">

  <meta name="mobile-web-app-capable" content="yes">
</head>
<body>
  <!-- Mid-onboarding modal (unstyled for now) -->
  <div id="onboarding-modal" style="display:none;">
    <div class="modal-content">
      <h2>Welcome back</h2>
      <p class="soft-note">Would you like to continue where you left off, or start fresh?</p>
      <div class="actions">
        <button class="btn secondary" id="modal-startover">Start fresh</button>
        <button class="btn primary" id="modal-continue">Continue</button>
      </div>
    </div>
  </div>

  <div class="assistant-shell">
    <div class="assistant-card">
      <header class="assistant-header">
        <div class="brand">
          <div class="brand-mark"></div>
          <div>
            <div class="brand-name">PEAKORA</div>
            <div class="brand-tagline">Gentle guidance. Real momentum.</div>
          </div>
        </div>
      </header>

      <div class="assistant-progress">
        <div class="progress-label">Step 1 of 13</div>
        <div class="progress-bar">
          <div class="progress-fill"></div>
        </div>
      </div>

      <main id="step-container" class="assistant-body">
        <!-- Steps render here -->
      </main>

      <footer class="assistant-footer">
        © 2026 Peakora™ — For a Better You.
        <div class="footer-links">
          <a href="/privacy.html">Privacy Policy</a> |
          <a href="/terms.html">Terms of Service</a>
        </div>
        <!-- Social icons remain exactly as in your file -->
      </footer>
    </div>
  </div>

  <script>
    /* INSTALL + DEVICE DETECTION */
    let deferredPrompt = null;
    let isInstalled =
      window.matchMedia("(display-mode: standalone)").matches ||
      window.navigator.standalone === true;

    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isDesktop = !isMobile;

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    const steps = [
      "welcome",
      "explanation",
      "goal",
      "challenge",
      "time",
      "insight",
      "extended1",
      "extended2",
      "email",
      "processing",
      "recommendations",
      "pricing",
      "themes",
      "picks",
      "story",
      "done",
      "daily_intro",
      "daily_checkin",
      "daily_summary",
      "breathing",
      "journal",
      "reset_focus",
      "install_prompt",
      "plan_full",
      "home",
      "exit"
    ];
    const onboardingSteps = [
      "welcome",
      "explanation",
      "goal",
      "challenge",
      "time",
      "insight",
      "extended1",
      "extended2",
      "email",
      "processing",
      "recommendations",
      "pricing",
      "themes",
      "picks",
      "story",
      "done"
    ];

    const STORAGE_KEY = "peakora_assistant_state_v1";
    const CHECKINS_KEY = "peakora_checkins_v1";

    const state = {
      stepIndex: 0,
      answers: {},
      email: "",
      completed: false,
      installPromptShown: false,
      plan: null,
      planStartDate: null
    };

    let focusTools = false;
    let focusPlan = false;

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      try {
        const parsed = JSON.parse(raw);
        state.stepIndex = parsed.stepIndex || 0;
        state.answers = parsed.answers || {};
        state.email = parsed.email || "";
        state.completed = !!parsed.completed;
        state.installPromptShown = !!parsed.installPromptShown;
        state.plan = parsed.plan || null;
        state.planStartDate = parsed.planStartDate || null;
        return true;
      } catch {
        return false;
      }
    }

    function clearState() {
      localStorage.removeItem(STORAGE_KEY);
      state.stepIndex = 0;
      state.answers = {};
      state.email = "";
      state.completed = false;
      state.installPromptShown = false;
      state.plan = null;
      state.planStartDate = null;
    }

    function getCheckins() {
      const raw = localStorage.getItem(CHECKINS_KEY);
      if (!raw) return [];
      try {
        return JSON.parse(raw) || [];
      } catch {
        return [];
      }
    }

    function addCheckin(feeling) {
      const list = getCheckins();
      const today = new Date().toISOString().slice(0, 10);
      list.push({ date: today, feeling });
      localStorage.setItem(CHECKINS_KEY, JSON.stringify(list.slice(-30)));
    }

    /* Mood bubbles helpers + placeholder */

    const PLACEHOLDER_WEEK = [
      { date: "2026-01-21", feeling: "tired" },
      { date: "2026-01-22", feeling: "steady" },
      { date: "2026-01-23", feeling: "wired" },
      { date: "2026-01-24", feeling: "flat" },
      { date: "2026-01-25", feeling: "hopeful" },
      { date: "2026-01-26", feeling: "better" },
      { date: "2026-01-27", feeling: "light" }
    ];

    function getMoodFamily(feeling) {
      const f = (feeling || "").toLowerCase();
      if (!f) return "neutral";

      if (
        f.includes("tired") ||
        f.includes("drained") ||
        f.includes("sad") ||
        f.includes("heavy")
      ) {
        return "heavy";
      }
      if (f.includes("wired") || f.includes("overwhelm") || f.includes("anxious")) {
        return "anxious";
      }
      if (
        f.includes("hopeful") ||
        f.includes("better") ||
        f.includes("light") ||
        f.includes("uplift")
      ) {
        return "hopeful";
      }
      if (f.includes("ready") || f.includes("strong") || f.includes("energ")) {
        return "energized";
      }
      if (f.includes("flat")) {
        return "neutral";
      }
      if (f.includes("steady") || f.includes("okay") || f.includes("ok")) {
        return "neutral";
      }
      return "neutral";
    }
    function getMoodColor(family) {
      switch (family) {
        case "heavy":
          return "#E8A0A0";
        case "anxious":
          return "#F5C26B";
        case "hopeful":
          return "#AEE6C5";
        case "energized":
          return "#6EC8C8";
        case "neutral":
        default:
          return "#F5B35C";
      }
    }

    function getMoodSize(feeling) {
      const f = (feeling || "").toLowerCase();
      if (f.includes("tired")) return 26;
      if (f.includes("steady")) return 32;
      if (f.includes("wired")) return 28;
      if (f.includes("flat")) return 30;
      if (f.includes("hopeful")) return 36;
      if (f.includes("better")) return 38;
      if (f.includes("light")) return 40;
      return 30;
    }

    function getLast7CheckinsOrPlaceholder() {
      const real = getCheckins();
      if (real && real.length >= 1) {
        return real.slice(-7);
      }
      return PLACEHOLDER_WEEK;
    }

    function renderMoodBubbles() {
      const canvas = document.getElementById("mood-bubble-canvas");
      const summaryEl = document.getElementById("mood-summary-text");
      if (!canvas || !summaryEl) return;

      const data = getLast7CheckinsOrPlaceholder();
      canvas.innerHTML = "";

      if (!data.length) {
        summaryEl.textContent = "You haven’t checked in yet this week.";
        return;
      }

      const width = canvas.clientWidth || 320;
      const height = canvas.clientHeight || 200;
      const count = data.length;

      const xStep = count > 1 ? (width - 40) / (count - 1) : 0;
      const yBase = height / 2;

      const families = [];
      const feelingsSequence = [];

      data.forEach((item, index) => {
        const feeling = item.feeling || item.mood || "";
        const family = getMoodFamily(feeling);
        const color = getMoodColor(family);
        const size = getMoodSize(feeling) * 1.3;

        families.push(family);
        feelingsSequence.push((feeling || "").toLowerCase() || "…");

        const x = 20 + xStep * index;
        const drift = (index % 2 === 0 ? -1 : 1) * (6 + (index % 3));
        const y = yBase + drift;

        const bubble = document.createElement("div");
        bubble.className = "mood-bubble";
        bubble.style.width = size + "px";
        bubble.style.height = size + "px";
        bubble.style.left = x - size / 2 + "px";
        bubble.style.top = y - size / 2 + "px";
        bubble.style.background =
          "radial-gradient(circle at 30% 30%, " + color + ", #f58b5c)";
        bubble.style.animationDelay = index * 0.6 + "s";
        bubble.title = feeling || "No label";

        canvas.appendChild(bubble);
      });

      const familyCounts = families.reduce((acc, f) => {
        acc[f] = (acc[f] || 0) + 1;
        return acc;
      }, {});
      let dominantFamily = "neutral";
      let maxCount = 0;
      Object.keys(familyCounts).forEach((f) => {
        if (familyCounts[f] > maxCount) {
          maxCount = familyCounts[f];
          dominantFamily = f;
        }
      });

      const summaryColor = getMoodColor(dominantFamily);
      const summaryBubble = document.createElement("div");
      summaryBubble.className = "week-summary-bubble";
      summaryBubble.style.background =
        "radial-gradient(circle at 30% 30%, " + summaryColor + ", #f58b5c)";
      canvas.appendChild(summaryBubble);
      summaryBubble.style.position = "absolute";
      summaryBubble.style.left = width - 60 + "px";
      summaryBubble.style.top = "10px";

      const sequenceText = feelingsSequence.join(" → ");
      summaryEl.textContent = "This week leaned toward: " + sequenceText + ".";
    }

    function goToStepKey(key) {
      const index = steps.indexOf(key);
      if (index >= 0) {
        state.stepIndex = index;
        saveState();
        renderStep();
      }
    }

    function goToPrevious() {
      if (state.stepIndex > 0) {
        state.stepIndex -= 1;
        saveState();
        renderStep();
      }
    }

    function fadeIn() {
      const el = document.getElementById("step-container");
      if (el) {
        el.classList.remove("fade");
        void el.offsetWidth;
        el.classList.add("fade");
      }
    }

    function setProgress() {
      const key = steps[state.stepIndex];
      const bar = document.querySelector(".progress-fill");
      const label = document.querySelector(".progress-label");
      const progressContainer = document.querySelector(".assistant-progress");
      if (!bar || !label || !progressContainer) return;

      // Hide progress on home and full plan
      if (key === "home" || key === "plan_full") {
        progressContainer.style.display = "none";
        return;
      } else {
        progressContainer.style.display = "";
      }

      const onboardingIndex = onboardingSteps.indexOf(key);
      if (onboardingIndex === -1) {
        bar.style.width = "100%";
        label.textContent =
          "Step " + (state.stepIndex + 1) + " of " + steps.length;
        return;
      }

      const pct = ((onboardingIndex + 1) / onboardingSteps.length) * 100;
      bar.style.width = pct + "%";
      label.textContent =
        "Step " + (onboardingIndex + 1) + " of " + onboardingSteps.length;
    }

    function goHomeAndFocusTools() {
      focusTools = true;
      goToStepKey("home");
    }
    function goHomeAndFocusPlan() {
      focusPlan = true;
      goToStepKey("home");
    }
    function getTodayPlanIndex() {
      if (!state.plan || !state.planStartDate) return 0;
      const start = new Date(state.planStartDate);
      const today = new Date();
      const diffMs = today.setHours(0,0,0,0) - start.setHours(0,0,0,0);
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      if (diffDays < 0) return 0;
      if (diffDays > 6) return 6;
      return diffDays;
    }

    function generatePlanFromAnswers(answers) {
      const goal = (answers.goal || "feeling a bit more steady").toLowerCase();
      const challenge = (answers.challenge || "what’s been weighing on you").toLowerCase();
      const time = answers.time || "5–10 minutes";
      const gentleWin = answers.extended1 || "one small thing that feels kind";
      const obstacles = answers.extended2 || "the usual things that get in the way";
      const insight = answers.insight || "";

      const timePhrase =
        time.indexOf("5") !== -1 ? "just a few minutes" :
        time.indexOf("15") !== -1 ? "about a quarter of an hour" :
        "a bit more focused time";

      const baseForgiveness =
        "If today feels heavier than you expected, do the smallest version of this and call it a win.";

      const days = [];

      days.push({
        title: "Day 1 — Grounding",
        focus: "Start gently, not perfectly.",
        action:
          "Take " + timePhrase + " to do one tiny action toward your goal around " + goal + ". " +
          "Keep it so small it almost feels too easy.",
        reflection:
          "At the end of the day, notice one moment where you chose care over pressure.",
        forgiveness: baseForgiveness
      });

      days.push({
        title: "Day 2 — Light momentum",
        focus: "Build a little movement without forcing it.",
        action:
          "Repeat yesterday’s tiny action, then add one more small step that supports it. " +
          "Think of it as stacking kindness, not effort.",
        reflection:
          "Ask yourself: “What made this feel easier or harder today?”",
        forgiveness:
          "If you didn’t get to it, imagine how you’d speak to a friend in your exact situation—and offer yourself the same tone."
      });

      days.push({
        title: "Day 3 — Reset and soften",
        focus: "Make space for how you actually feel.",
        action:
          "Take a short pause—one slow breath in, one softer breath out, repeated a few times. " +
          "Then name, in a sentence, how " + challenge + " has been showing up.",
        reflection:
          "You can jot down one sentence about what you’re carrying. That’s enough.",
        forgiveness:
          "If this feels like too much today, just do the breathing part and skip the rest."
      });

      days.push({
        title: "Day 4 — Gentle win",
        focus: "Give yourself a clear, kind win.",
        action:
          "Choose the gentle win you named earlier: “" + gentleWin + "”. " +
          "Do the smallest version of it today, even if it’s imperfect.",
        reflection:
          "Notice how it feels in your body to follow through on something small you chose for yourself.",
        forgiveness:
          "If you don’t get to it, that doesn’t erase your progress. You’re still in the week, not out of it."
      });

      days.push({
        title: "Day 5 — Navigating obstacles",
        focus: "Work with your patterns, not against them.",
        action:
          "Look at what usually throws you off: “" + obstacles + "”. " +
          "Pick one tiny way to soften or sidestep that pattern just for today.",
        reflection:
          "Ask: “What would make this 10% easier next time?” and capture one idea.",
        forgiveness:
          "If the pattern wins today, that’s data, not failure. You’re learning how your life actually works."
      });

      days.push({
        title: "Day 6 — Check-in and adjust",
        focus: "Listen to your energy honestly.",
        action:
          "Do a quick check-in: how does your energy feel today in one sentence? " +
          (insight ? "You mentioned before: “" + insight + "”. See if that still feels true." : "Just name it without judging it.") ,
        reflection:
          "Based on how you feel, decide whether tomorrow should be lighter, similar, or a bit more active.",
        forgiveness:
          "If you skip today, tomorrow can still be a reset. You’re allowed to restart inside the same week."
      });

      days.push({
        title: "Day 7 — Integration",
        focus: "Gather what worked, gently.",
        action:
          "Look back over the week and choose one thing you’d like to keep for next week—no more than that.",
        reflection:
          "Finish the sentence: “This week reminded me that I can…”",
        forgiveness:
          "If this week felt messy, that’s still a week of paying attention. That matters more than a perfect streak."
      });

      return days;
    }

    function ensurePlanGenerated() {
      if (!state.plan) {
        state.plan = generatePlanFromAnswers(state.answers);
        state.planStartDate = new Date().toISOString().slice(0, 10);
        saveState();
      }
    }
    function renderStep() {
      fadeIn();
      const container = document.getElementById("step-container");
      const key = steps[state.stepIndex];
      setProgress();

      if (key === "welcome") {
        container.innerHTML =
          '<div class="step">' +
          "<h1>Hi, I’m Peakora.</h1>" +
          "<p>Let’s take a gentle step toward the version of you that feels more grounded and steady.</p>" +
          '<div class="actions">' +
          '<button class="btn secondary" onclick="goToStepKey(\'home\')">Back</button>' +
          '<button class="btn primary" onclick="goToStepKey(\'explanation\')">Begin</button>' +
          "</div>" +
          "</div>";
        return;
      }

      if (key === "explanation") {
        container.innerHTML =
          '<div class="step">' +
          "<h2>How this works</h2>" +
          "<p>I’ll ask a few simple questions about your energy, your time, and what’s been weighing on you.</p>" +
          "<p>Then I’ll shape a 7-day plan that feels doable, not overwhelming.</p>" +
          '<div class="actions">' +
          '<button class="btn secondary" onclick="goToPrevious()">Back</button>' +
          '<button class="btn primary" onclick="goToStepKey(\'goal\')">Continue</button>' +
          "</div>" +
          "</div>";
        return;
      }

      if (key === "goal") {
        container.innerHTML =
          '<div class="step">' +
          "<h2>What’s one area you’d like to feel better in?</h2>" +
          '<textarea class="input" id="goal-input" placeholder="Sleep, stress, focus, movement… whatever feels true."></textarea>' +
          '<p class="tiny-note">This helps me shape a plan that actually fits your life. Please don’t skip it.</p>' +
          '<div class="actions">' +
          '<button class="btn secondary" onclick="goToPrevious()">Back</button>' +
          '<button class="btn primary" onclick="handleGoal()">Continue</button>' +
          "</div>" +
          "</div>";
        return;
      }

      if (key === "challenge") {
        container.innerHTML =
          '<div class="step">' +
          "<h2>What’s been making this hard lately?</h2>" +
          '<textarea class="input" id="challenge-input" placeholder="Be honest. Overwhelm, time, burnout, pain…"></textarea>' +
          '<p class="tiny-note">Sharing this helps me design a plan that works with your reality, not against it.</p>' +
          '<div class="actions">' +
          '<button class="btn secondary" onclick="goToPrevious()">Back</button>' +
          '<button class="btn primary" onclick="handleChallenge()">Continue</button>' +
          "</div>" +
          "</div>";
        return;
      }

      if (key === "time") {
        container.innerHTML =
          '<div class="step">' +
          "<h2>How much time feels doable for you right now?</h2>" +
          '<div class="options">' +
          '<button class="btn ghost" onclick="handleTime(\'5–10 minutes\')">5–10 minutes</button>' +
          '<button class="btn ghost" onclick="handleTime(\'15–20 minutes\')">15–20 minutes</button>' +
          '<button class="btn ghost" onclick="handleTime(\'30+ minutes\')">30+ minutes</button>' +
          "</div>" +
          '<p class="tiny-note">This shapes the size of your daily steps so they stay realistic.</p>' +
          '<div class="actions">' +
          '<button class="btn secondary" onclick="goToPrevious()">Back</button>' +
          "</div>" +
          "</div>";
        return;
      }

      if (key === "insight") {
        container.innerHTML =
          '<div class="step">' +
          "<h2>Is there anything else I should know about your energy or mood lately?</h2>" +
          '<textarea class="input" id="insight-input" placeholder="You can skip this if nothing comes to mind."></textarea>' +
          '<p class="tiny-note">You can skip this, but sharing a bit more helps me shape a stronger plan for you.</p>' +
          '<div class="actions">' +
          '<button class="btn secondary" onclick="goToPrevious()">Back</button>' +
          '<button class="btn primary" onclick="handleInsight()">Continue</button>' +
          "</div>" +
          "</div>";
        return;
      }

      if (key === "extended1") {
        container.innerHTML =
          '<div class="step">' +
          "<h2>What would feel like a gentle win this week?</h2>" +
          '<textarea class="input" id="extended1-input" placeholder="Something small, kind, and realistic."></textarea>' +
          '<p class="tiny-note">You can skip this, but naming a gentle win helps me give you something to look forward to.</p>' +
          '<div class="actions">' +
          '<button class="btn secondary" onclick="goToPrevious()">Back</button>' +
          '<button class="btn primary" onclick="handleExtended1()">Continue</button>' +
          "</div>" +
          "</div>";
        return;
      }
      if (key === "extended2") {
        container.innerHTML =
          '<div class="step">' +
          "<h2>What tends to throw you off when you try to make changes?</h2>" +
          '<textarea class="input" id="extended2-input" placeholder="Patterns, triggers, thoughts…"></textarea>' +
          '<p class="tiny-note">You can skip this, but knowing your patterns helps me design a plan that doesn’t fight them.</p>' +
          '<div class="actions">' +
          '<button class="btn secondary" onclick="goToPrevious()">Back</button>' +
          '<button class="btn primary" onclick="handleExtended2()">Continue</button>' +
          "</div>" +
          "</div>";
        return;
      }

      if (key === "email") {
        container.innerHTML =
          '<div class="step">' +
          "<h2>Where should I send your plan?</h2>" +
          '<input type="email" class="input" id="email-input" placeholder="you@example.com" value="' +
          (state.email || "") +
          '">' +
          '<p class="tiny-note">I’ll send your full 7-day plan here so you can keep it close.</p>' +
          '<div class="actions">' +
          '<button class="btn secondary" onclick="goToPrevious()">Back</button>' +
          '<button class="btn primary" onclick="handleEmail()">Send my plan</button>' +
          "</div>" +
          "</div>";
        return;
      }

      if (key === "themes") {
        container.innerHTML =
          '<div class="step">' +
          "<h2>Choose your theme</h2>" +
          '<div class="options">' +
          '<button class="btn ghost" onclick="document.body.classList.remove(\'dark\')">Light</button>' +
          '<button class="btn ghost" onclick="document.body.classList.add(\'dark\')">Dark</button>' +
          "</div>" +
          "</div>";
        return;
      }

      if (key === "picks") {
        container.innerHTML =
          '<div class="step">' +
          "<h2>Peakora Picks</h2>" +
          "<p class='soft-note'>Curated gentle recommendations for you:</p>" +
          '<ul class="preview-list">' +
          "<li>Try a 2-minute breathing reset</li>" +
          "<li>Write one sentence in your micro-journal</li>" +
          "<li>Step outside for fresh air</li>" +
          "</ul>" +
          '<div class="actions">' +
          '<button class="btn primary" onclick="goToStepKey(\'home\')">Back to home</button>' +
          "</div>" +
          "</div>";
        return;
      }

      if (key === "story") {
        container.innerHTML =
          '<div class="step">' +
          "<h2>Share your story</h2>" +
          '<textarea class="input" id="story-input" placeholder="Write a few words about your journey…"></textarea>' +
          '<div class="actions">' +
          '<button class="btn secondary" onclick="goToStepKey(\'home\')">Cancel</button>' +
          '<button class="btn primary" onclick="handleStory()">Save</button>' +
          "</div>" +
          "</div>";
        return;
      }
    }

    function handleGoal() {
      const el = document.getElementById("goal-input");
      const value = (el && el.value.trim()) || "";
      if (!value) {
        alert("Please share at least a few words about what you’d like to feel better in.");
        return;
      }
      state.answers.goal = value;
      saveState();
      goToStepKey("challenge");
    }

    function handleChallenge() {
      const el = document.getElementById("challenge-input");
      const value = (el && el.value.trim()) || "";
      if (!value) {
        alert("Please share what’s been making this hard lately, even in a simple sentence.");
        return;
      }
      state.answers.challenge = value;
      saveState();
      goToStepKey("time");
    }

    function handleTime(choice) {
      if (!choice) {
        alert("Please choose the amount of time that feels doable for you.");
        return;
      }
      state.answers.time = choice;
      saveState();
      goToStepKey("insight");
    }

    function handleInsight() {
      const el = document.getElementById("insight-input");
      const value = (el && el.value.trim()) || "";
      state.answers.insight = value;
      saveState();
      goToStepKey("extended1");
    }

    function handleExtended1() {
      const el = document.getElementById("extended1-input");
      const value = (el && el.value.trim()) || "";
      state.answers.extended1 = value;
      saveState();
      goToStepKey("extended2");
    }

    function handleExtended2() {
      const el = document.getElementById("extended2-input");
      const value = (el && el.value.trim()) || "";
      state.answers.extended2 = value;
      saveState();
      goToStepKey("email");
    }

    function handleEmail() {
      const el = document.getElementById("email-input");
      const value = (el && el.value.trim()) || "";
      if (!value || value.indexOf("@") === -1) {
        alert("Please enter a valid email address so I can send your plan.");
        return;
      }
      state.email = value;
      saveState();
      goToStepKey("processing");
    }

    function handleStory() {
      const el = document.getElementById("story-input");
      const value = (el && el.value.trim()) || "";
      state.answers.story = value;
      saveState();
      goToStepKey("home");
    }

    function handleDailyStart() {
      goToStepKey("daily_intro");
    }

    function handleDailyCheckin() {
      const el = document.getElementById("daily-checkin-input");
      const value = (el && el.value.trim()) || "";
      state.answers.daily_checkin = value;
      addCheckin(value);
      saveState();
      goToStepKey("daily_summary");
    }

    function handleJournal() {
      const el = document.getElementById("journal-input");
      const value = (el && el.value.trim()) || "";
      saveState();
      goToStepKey("home");
    }

    function handleResetFocus() {
      const el = document.getElementById("reset-focus-input");
      const value = (el && el.value.trim()) || "";
      saveState();
      goToStepKey("home");
    }

    function restartOnboarding() {
      clearState();
      state.stepIndex = steps.indexOf("welcome");
      saveState();
      renderStep();
    }

    function handleBackToHome() {
      window.location.href = "index.html";
    }

    function triggerInstall() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.finally(function () {
          deferredPrompt = null;
        });
      }
    }

    function showOnboardingModal() {
      const modal = document.getElementById("onboarding-modal");
      if (!modal) {
        const currentKey = steps[state.stepIndex] || "welcome";
        goToStepKey(currentKey);
        return;
      }

      modal.style.display = "block";

      const startOverBtn = document.getElementById("modal-startover");
      const continueBtn = document.getElementById("modal-continue");

      if (startOverBtn) {
        startOverBtn.onclick = function () {
          clearState();
          modal.style.display = "none";
          goToStepKey("welcome");
        };
      }

      if (continueBtn) {
        continueBtn.onclick = function () {
          modal.style.display = "none";
          const currentKey = steps[state.stepIndex] || "welcome";
          goToStepKey(currentKey);
        };
      }
    }
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const hasState = loadState();

      if (!hasState) {
        goToStepKey("welcome");
        return;
      }

      if (state.completed) {
        goToStepKey("home");
        return;
      }

      showOnboardingModal();
    });
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./service-worker.js");
    }
  </script>
</body>
</html>
